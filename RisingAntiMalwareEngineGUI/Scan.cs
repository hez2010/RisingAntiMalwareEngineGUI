using System;
using System.Diagnostics;
using System.IO;
using System.Threading;
using System.Threading.Tasks;
using System.Management;
using Newtonsoft.Json.Linq;

namespace RisingAntiMalwareEngineGUI
{
    class Scan
    {
        private JObject _objJsonResult;
        private string _last;
        private bool _flag;

        private void ParseJsonResult(string strResultJson, ref VirInfo obj)
        {
            string temp = _last + strResultJson;
            if (temp.IndexOf("{", StringComparison.Ordinal) >= 0)
            {
                _flag = true;
                obj.FinishFlag = false;
                obj.IsSelected = false;
                try
                {
                    _objJsonResult = JObject.Parse(temp);
                    obj.FileName = _objJsonResult["filename"].ToString();
                    obj.VirName = _objJsonResult["infect"]["threat"].ToString();
                    obj.DetectEngine = _objJsonResult["infect"]["engine"].ToString();
                }
                catch
                {
                    try
                    {
                        obj.FileName = _objJsonResult["filename"].ToString();
                        obj.VirName = obj.DetectEngine = "";
                    }
                    catch
                    {
                        obj.FileName = "";
                        _last = temp;
                    }
                }
            }
            else if (_flag)
            {
                obj.FinishFlag = true;
                obj.FileName = "查杀完毕";
            }
        }
        private Process _scanProcess;
        private int sleepInterval = 1000;
        private TimeSpan prevCpuTime = TimeSpan.Zero;
        private TimeSpan curCpuTime = TimeSpan.Zero;
        private long iTotalPhysicalMem = 0;

        private void GetTotalPhysicalMem()
        {
            ManagementClass mc = new ManagementClass("Win32_ComputerSystem");
            ManagementObjectCollection moc = mc.GetInstances();
            foreach (ManagementObject mo in moc)
            {
                if (mo["TotalPhysicalMemory"] != null)
                {
                    iTotalPhysicalMem = long.Parse(mo["TotalPhysicalMemory"].ToString());
                }
            }
        }
        private void GetCpuAndRamUsagePercent(ref ResUsageInfo objResUsageInfo)
        {
            //calc cpu usage
            curCpuTime = _scanProcess.TotalProcessorTime;
            objResUsageInfo.CpuUsagePercent = (int) ((curCpuTime - prevCpuTime).TotalMilliseconds * 100 / sleepInterval /
                               Environment.ProcessorCount);
            prevCpuTime = curCpuTime;
            //calc ram usage
            if (iTotalPhysicalMem == 0)
            {
                GetTotalPhysicalMem();
            }
            objResUsageInfo.RamUsagePercent = (int) (_scanProcess.WorkingSet64 * 100 / iTotalPhysicalMem);
        }
        public bool Start(string fileName, string _params, Action<VirInfo> reCallAction, Action<ResUsageInfo> reCallAction_2)
        {
            if (!Directory.Exists(fileName) && !File.Exists(fileName))
            {
                return false;
            }
            _flag = false;
            _last = "";
            Scaning(fileName, _params, reCallAction, reCallAction_2);
            return true;
        }

        public void StopScan()
        {
            try
            {
                _scanProcess.Kill();
                _scanProcess.Dispose();
            }
            catch
            {
                // ignored
            }
        }
        private void Scaning(string fileName, string _params, Action<VirInfo> reCallAction, Action<ResUsageInfo> reCallAction_2)
        {
            Task.Run(() =>
            {
                _scanProcess = new Process
                {
                    StartInfo =
                    {
                        Arguments = "\"" + fileName + "\"" + " -output-json" + _params,
                        FileName = "ramecl.exe",
                        RedirectStandardOutput = true,
                        CreateNoWindow = true,
                        WindowStyle = ProcessWindowStyle.Hidden,
                        UseShellExecute = false
                    }
                };
                _scanProcess.Start();
                _scanProcess.BeginOutputReadLine();
                _scanProcess.OutputDataReceived += (o, args) =>
                {
                    if (!String.IsNullOrEmpty(args.Data))
                    {
                        VirInfo objvirInfo = new VirInfo();
                        ParseJsonResult(args.Data, ref objvirInfo);
                        if(!String.IsNullOrEmpty(objvirInfo.FileName))
                        {
                            reCallAction(objvirInfo);
                        }
                    }
                };
                while (!_scanProcess.HasExited)
                {
                    try
                    {
                        ResUsageInfo objResUsageInfo=new ResUsageInfo();
                        GetCpuAndRamUsagePercent(ref objResUsageInfo);
                        reCallAction_2(objResUsageInfo);
                    }
                    catch
                    {
                        //ignored
                    }
                    Thread.Sleep(sleepInterval);
                }
                reCallAction(new VirInfo("", "", "", true, false));
            });
        }
    }
}
