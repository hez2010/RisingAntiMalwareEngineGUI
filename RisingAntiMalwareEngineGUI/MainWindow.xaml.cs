using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Diagnostics;
using System.IO;
using System.Management;
using System.Net;
using System.Reflection;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Animation;
using ICSharpCode.SharpZipLib.Zip;
using Microsoft.Research.DynamicDataDisplay;
using Microsoft.Research.DynamicDataDisplay.DataSources;
using Newtonsoft.Json.Linq;

namespace RisingAntiMalwareEngineGUI
{
    /// <summary>
    /// MainWindow.xaml 的交互逻辑
    /// </summary>
    public partial class MainWindow
    {
        private ObservableCollection<VirInfo> VirInfoList { get; set; } = new ObservableCollection<VirInfo>();
        private ObservableCollection<Folder> FolderList { get; set; } = new ObservableCollection<Folder>();

        private void EnableAllFuncBtn()
        {
            DeleteItems.IsEnabled = true;
            PackItems.IsEnabled = true;
            //UploadItems.IsEnabled = true;
        }

        private void DisableAllFuncBtn()
        {
            DeleteItems.IsEnabled = false;
            PackItems.IsEnabled = false;
            //UploadItems.IsEnabled = false;
        }

        public MainWindow()
        {
            InitializeComponent();
            CheckUpdate();
            Form.Height = 150;
            VersionLabel.Content = "RAMECL GUI Version: " + (Assembly.GetExecutingAssembly().GetName()
                                       .Version);
            LbProgramVer.Content = Assembly.GetExecutingAssembly().GetName().Version.ToString();
            InitTask();

            CpuPlotter.AddLineGraph(_dataSourceCpu, Colors.Green, 2);
            CpuPlotter.LegendVisible = false;
            MemPlotter.AddLineGraph(_dataSourceMem, Colors.Green, 2);
            MemPlotter.LegendVisible = false;
            CpuPlotter.Viewport.FitToView();
            MemPlotter.Viewport.FitToView();
        }

        private long _folderTreeCount;

        private void InitFolderTree()
        {
            FolderList.Clear();
            foreach (var i in GetDeviceId())
            {
                FolderList.Add(new Folder { Name = i, Count = ++_folderTreeCount });
            }
            foreach (var i in FolderList)
            {
                try
                {
                    foreach (var j in Directory.GetDirectories(i.Name + "\\"))
                    {
                        i.Children.Add(new Folder { Name = Path.GetFileName(j), Count = ++_folderTreeCount });
                    }
                }
                catch
                {
                    // ignored
                }
            }
        }

        private void MainWindow_Loaded(object sender, RoutedEventArgs e)
        {
            ListViewVirInfo.ItemsSource = VirInfoList;
            FolderTree.ItemsSource = FolderList;
            ScanProcessBar.Visibility = Visibility.Hidden;
            FolderLoading.Visibility = Visibility.Hidden;
            ResultGrid.Visibility = Visibility.Hidden;
            ConfigGrid.Visibility = Visibility.Hidden;
        }

        private void LabelShow()
        {
            Task.Run(() =>
            {
                Dispatcher.BeginInvoke((Action)(() =>
               {
                   DoubleAnimation daV = new DoubleAnimation(0, 1, new Duration(TimeSpan.FromSeconds(1)));
                   InitLabel.BeginAnimation(OpacityProperty, daV);
               }));
            });
        }

        private void LabelGo()
        {
            Task.Run(() =>
            {
                Thread.Sleep(500);
                LabelShow();
                for (int i = 0; i <= 606; i += 4)
                {
                    Dispatcher.BeginInvoke((Action)(() =>
                   {
                       InitLabel.Width = i;
                   }));
                    Thread.Sleep(10);
                }
                Dispatcher.BeginInvoke((Action)(() =>
               {
                   InitLabel.Width = 606;
               }));
                WindowShow();
                Dispatcher.BeginInvoke((Action)(() =>
               {
                   DoubleAnimation daV = new DoubleAnimation(1, 0, new Duration(TimeSpan.FromSeconds(1)));
                   InitLabel.BeginAnimation(OpacityProperty, daV);
               }));
                Thread.Sleep(1000);
                Dispatcher.BeginInvoke((Action)(() =>
               {
                   InitLabel.Margin = new Thickness(0, 90, 0, 0);
                   InitLabel.Width = Form.Width;
                   InitLabel.Background = Brushes.Black;
                   DoubleAnimation daV = new DoubleAnimation(0, 1, new Duration(TimeSpan.FromSeconds(1)));
                   InitLabel.BeginAnimation(OpacityProperty, daV);
               }));
            });
        }

        private void WindowShow()
        {
            Task.Run(() =>
            {
                for (int i = 150; i <= 490; i += 10)
                {
                    Dispatcher.BeginInvoke((Action)(() =>
                   {
                       Form.Height = i;
                   }));
                    Thread.Sleep(10);
                }
                Dispatcher.BeginInvoke((Action)(() =>
               {
                   Form.Height = 500;
               }));
            });
        }

        private void InitTask()
        {
            LabelGo();
            InitFolderTree();
        }

        private List<string> GetDeviceId()
        {
            List<string> deviceIDs = new List<string>();
            ManagementObjectSearcher query = new ManagementObjectSearcher("SELECT  *  From  Win32_LogicalDisk ");
            ManagementObjectCollection queryCollection = query.Get();
            foreach (var o in queryCollection)
            {
                var mo = (ManagementObject)o;

                switch (int.Parse(mo["DriveType"].ToString()))
                {
                    case (int)DriveType.Removable: //可以移动磁盘     
                        {
                            //MessageBox.Show("可以移动磁盘");
                            deviceIDs.Add(mo["DeviceID"].ToString());
                            break;
                        }
                    case (int)DriveType.Fixed: //本地磁盘     
                        {
                            //MessageBox.Show("本地磁盘");
                            deviceIDs.Add(mo["DeviceID"].ToString());
                            break;
                        }
                    case (int)DriveType.CDRom: //CD   rom   drives     
                        {
                            //MessageBox.Show("CD   rom   drives ");
                            deviceIDs.Add(mo["DeviceID"].ToString());
                            break;
                        }
                    case (int)DriveType.Network: //网络驱动   
                        {
                            //MessageBox.Show("网络驱动器 ");
                            break;
                        }
                    case (int)DriveType.Ram:
                        {
                            //MessageBox.Show("驱动器是一个 RAM 磁盘 ");
                            deviceIDs.Add(mo["DeviceID"].ToString());
                            break;
                        }
                    case (int)DriveType.NoRootDirectory:
                        {
                            //MessageBox.Show("驱动器没有根目录 ");
                            break;
                        }
                }
            }
            return deviceIDs;
        }

        private bool _flag;

        private void CheckUpdate()
        {
            Task.Run(() =>
            {
                try
                {
                    HttpWebRequest request =
                        WebRequest.Create("http://www.universeinc.cn/rising/update.txt") as HttpWebRequest;
                    HttpWebResponse response = request?.GetResponse() as HttpWebResponse;
                    Stream responseStream = response?.GetResponseStream();
                    if (responseStream != null)
                    {
                        byte[] bytes = new byte[1024];
                        List<byte> allInfo = new List<byte>();
                        while (responseStream.Read(bytes, 0, 1024) > 0)
                        {
                            allInfo.AddRange(bytes);
                        }
                        string updateinfo = Encoding.Default.GetString(allInfo.ToArray());
                        Console.Write(updateinfo);
                        if (updateinfo.IndexOf("{", StringComparison.Ordinal) >= 0)
                        {
                            var b = JObject.Parse(updateinfo);
                            UpdateInfo a = new UpdateInfo
                            {
                                ForceUpdate = b["force"].ToString() == "1",
                                Version = b["version"].ToString(),
                                Content = b["content"].ToString(),
                                UpdateDate = b["date"].ToString(),
                                Url = b["url"].ToString(),
                                Program = b["program"].ToString()
                            };
                            if (a.Version != Assembly.GetExecutingAssembly().GetName().Version.ToString())
                            {
                                LbProgramVer.Content =
                                    Assembly.GetExecutingAssembly().GetName().Version + " (发现新版本 " + a.Version + ")";
                                if (a.ForceUpdate)
                                {
                                    UpdateNow(a);
                                }
                                else
                                {
                                    var res = MessageBox.Show(
                                        $"发现新版本: {a.Version}\r\n更新日期: {a.UpdateDate}\r\n更新内容: \r\n{a.Content}\r\n是否更新?",
                                        "提示", MessageBoxButton.YesNo, MessageBoxImage.Question);
                                    if (res == MessageBoxResult.Yes)
                                    {
                                        UpdateNow(a);
                                    }
                                }
                            }
                            else
                            {
                                Dispatcher.BeginInvoke((Action)(() =>
                                {
                                    LbProgramVer.Content =
                                        Assembly.GetExecutingAssembly().GetName().Version.ToString() + " (已是最新版本)";
                                }));

                            }
                        }
                        responseStream.Close();
                    }
                }
                catch
                {
                    // ignored
                }
            });

        }

        private void UpdateNow(UpdateInfo uinfo)
        {
            Task.Run(() =>
            {
                try
                {
                    HttpWebRequest request =
                        WebRequest.Create(uinfo.Url) as HttpWebRequest;
                    HttpWebResponse response = request?.GetResponse() as HttpWebResponse;
                    Stream responseStream = response?.GetResponseStream();
                    if (responseStream != null)
                    {
                        Stream stream =
                            new FileStream(Environment.GetEnvironmentVariable("temp") + "\\ramecl_GUI_update.zip",
                                FileMode.Create);
                        byte[] bArr = new byte[1024];
                        int dsize = responseStream.Read(bArr, 0, bArr.Length);
                        while (dsize > 0)
                        {
                            stream.Write(bArr, 0, dsize);
                            dsize = responseStream.Read(bArr, 0, bArr.Length);
                        }
                        stream.Close();
                        responseStream.Close();
                        UnZip(Environment.GetEnvironmentVariable("temp") + "\\ramecl_GUI_update.zip",
                            Environment.CurrentDirectory);
                        string batprogram = $@"@echo off
setlocal enabledelayedexpansion
title ramecl GUI Updater
cls
echo.
echo  正在更新... 请勿关闭本窗口
echo.
ping /n 3 0.0.0.0>nul
for /f ""tokens=* delims="" %%a in ('dir /s /a-d /b /q ""{Environment.CurrentDirectory}\*.toReplace""') do (
del /f /q ""%%~na""
ren ""%%a"" ""%%~na""
)
start """" ""{Environment.CurrentDirectory}\{uinfo.Program}""
";
                        if (File.Exists(Environment.GetEnvironmentVariable("temp") + "\\update_ramecl_bat.bat"))
                        {
                            File.Delete(Environment.GetEnvironmentVariable("temp") + "\\update_ramecl_bat.bat");
                        }
                        File.WriteAllBytes(Environment.GetEnvironmentVariable("temp") + "\\update_ramecl_bat.bat",
                            Encoding.GetEncoding("GBK").GetBytes(batprogram));
                        Process.Start(Environment.GetEnvironmentVariable("temp") + "\\update_ramecl_bat.bat");
                        Environment.Exit(0);
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"更新失败, 错误原因: {ex}", "提示", MessageBoxButton.OK, MessageBoxImage.Information);
                }
            });
            MessageBox.Show($"正在后台从旧版本更新至 {uinfo.Version}\r\n稍后程序将自动重新启动以完成更新",
                "提示", MessageBoxButton.OK, MessageBoxImage.Information);
        }

        private void UnZip(string zipFilePath, string unZipDir)
        {
            if (unZipDir == string.Empty)
            {
                unZipDir = zipFilePath.Replace(Path.GetFileName(zipFilePath),
                    Path.GetFileNameWithoutExtension(zipFilePath));
            }

            if (!unZipDir.EndsWith("/"))
            {
                unZipDir += "/";
            }
            if (!Directory.Exists(unZipDir))
                Directory.CreateDirectory(unZipDir);

            using (ZipInputStream s = new ZipInputStream(File.OpenRead(zipFilePath)))
            {

                ZipEntry theEntry;
                while ((theEntry = s.GetNextEntry()) != null)
                {
                    string directoryName = Path.GetDirectoryName(theEntry.Name);
                    string fileName = Path.GetFileName(theEntry.Name);
                    if (!string.IsNullOrEmpty(directoryName))
                    {
                        if (!directoryName.EndsWith("/"))
                        {
                            directoryName += "/";
                        }
                        Directory.CreateDirectory(unZipDir + directoryName);
                    }
                    if (fileName != String.Empty)
                    {
                        if (File.Exists(unZipDir + theEntry.Name))
                        {
                            using (FileStream streamWriter = File.Create(unZipDir + theEntry.Name + ".toReplace"))
                            {
                                byte[] data = new byte[2048];
                                while (true)
                                {
                                    var size = s.Read(data, 0, data.Length);
                                    if (size > 0)
                                    {
                                        streamWriter.Write(data, 0, size);
                                    }
                                    else
                                    {
                                        break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            using (FileStream streamWriter = File.Create(unZipDir + theEntry.Name))
                            {
                                byte[] data = new byte[2048];
                                while (true)
                                {
                                    var size = s.Read(data, 0, data.Length);
                                    if (size > 0)
                                    {
                                        streamWriter.Write(data, 0, size);
                                    }
                                    else
                                    {
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        private void WindowClosing()
        {
            Task.Run(() =>
            {
                for (int i = 500; i >= 10; i -= 10)
                {
                    Dispatcher.BeginInvoke((Action)(() =>
                   {
                       Form.Height = i;
                   }));
                    Thread.Sleep(10);
                }
                Dispatcher.BeginInvoke((Action)Close);
            });
        }
        private void WindowHiding()
        {
            Task.Run(() =>
            {
                Dispatcher.BeginInvoke((Action)(() =>
                {
                    DoubleAnimation daV = new DoubleAnimation(1, 0, new Duration(TimeSpan.FromSeconds(1)));
                    Form.BeginAnimation(OpacityProperty, daV);
                }));
            });
        }
        private void MainWindow_OnClosing(object sender, CancelEventArgs e)
        {
            WindowClosing();
            WindowHiding();
            if (!_flag)
            {
                e.Cancel = true;
            }
            _flag = true;
        }

        private void ScanRunning()
        {
            Task.Run(() =>
            {
                long count = 0;
                while (!_isfinished)
                {
                    Dispatcher.BeginInvoke((Action)(() =>
                    {
                        SpeedLabel.Content = (_lastcount - count == 0 ? (long)(_lastcount / ((DateTime.Now - _startDateTime).TotalSeconds == 0 ? 1 : (DateTime.Now - _startDateTime).TotalSeconds)) : _lastcount - count) + " 个/s";
                        count = _lastcount;
                        TimeLabel.Content = (DateTime.Now - _startDateTime).ToString(@"hh\:mm\:ss");
                    }));
                    Thread.Sleep(1000);
                }

            });
        }
        private int _fileCountTot;

        private void GetFileFigures(string path)
        {
            try
            {
                _fileCountTot += Directory.GetFiles(path).Length;
            }
            catch
            {
                // ignored
            }
            try
            {
                foreach (var i in Directory.GetDirectories(path))
                {
                    GetFileFigures(i);
                }
            }
            catch
            {
                // ignored
            }
        }
        private void FileProcessUpdate(string path)
        {
            Task.Run(() =>
            {
                GetFileFigures(path);
            });
            Task.Run(() =>
            {
                double lastCount = 0;
                Thread.Sleep(2000);
                while (!_isfinished)
                {
                    Dispatcher.BeginInvoke((Action)(() =>
                    {
                        double temp = 0;
                        if ((temp = _fileCountTot == 0 ? 0 : _lastcount * 100 / _fileCountTot) >= lastCount)
                        {
                            ScanProcessBar.Value = temp;
                        }
                        lastCount = ScanProcessBar.Value;
                    }));
                    Thread.Sleep(1000);
                }
            });
        }
        private long _lastcount;
        private bool _isfinished;
        private long _threat;
        private DateTime _startDateTime;
        private void UpdateVirInfoListView(VirInfo content)
        {
            Dispatcher.BeginInvoke((Action)(() =>
            {
                if (content.FinishFlag)
                {
                    ButtonStart.Content = "开始";
                    TbCurrentTarget.Text = "查杀完毕";
                    ScanProcessBar.Visibility = Visibility.Hidden;
                    FileNameTextBox.Visibility = Visibility.Visible;
                    SpeedLabel.Content = (long)(_lastcount / ((DateTime.Now - _startDateTime).TotalSeconds == 0 ? 1 : (DateTime.Now - _startDateTime).TotalSeconds)) + " 个/s";
                    EnableAllFuncBtn();
                    _isfinished = true;
                }
                else
                {
                    if (_lastcount++ == 0)
                    {
                        _startDateTime = DateTime.Now;
                        ScanRunning();
                    }
                    FileCountLabel.Content = _lastcount.ToString();
                    if (String.IsNullOrEmpty(content.VirName) || String.IsNullOrEmpty(content.DetectEngine))
                    {
                        TbCurrentTarget.Text = content.FileName;
                    }
                    else
                    {
                        VirInfoList.Add(new VirInfo(content.FileName, content.VirName, content.DetectEngine, content.FinishFlag, content.IsSelected, "尚未处理"));
                        ThreatLabel.Content = ++_threat;
                        TbCurrentTarget.Text = content.FileName;

                    }
                }
            }));
        }
        private ObservableDataSource<Point> _dataSourceCpu = new ObservableDataSource<Point>();
        private ObservableDataSource<Point> _dataSourceMem = new ObservableDataSource<Point>();
        private int _currentSecond;
        private void UpdateResUsageInfoView(ResUsageInfo content)
        {
            Dispatcher.BeginInvoke((Action)(() =>
            {
                if (content.CpuUsagePercent < -8)
                {
                    _currentSecond = 0;
                    _dataSourceCpu.Collection.Clear();
                    _dataSourceMem.Collection.Clear();
                    CpuPlotter.Viewport.FitToView();
                    MemPlotter.Viewport.FitToView();
                }
                else
                {
                    _currentSecond++;
                    double x = _currentSecond, y1 = content.CpuUsagePercent, y2 = content.RamUsage;
                    _dataSourceCpu.AppendAsync(Dispatcher, new Point(x, y1));
                    _dataSourceMem.AppendAsync(Dispatcher, new Point(x, y2));
                }
            }));
        }
        private Scan _scanInstance;
        private void Button_Click(object sender, RoutedEventArgs e)
        {
            if ((string)ButtonStart.Content == "开始")
            {
                if (!File.Exists("ramecl.exe"))
                {
                    MessageBox.Show("未找到扫描引擎! 请将引擎安装至当前目录", "提示", MessageBoxButton.OK, MessageBoxImage.Error);
                    return;
                }
                _lastcount = 0;
                _threat = 0;
                _isfinished = false;
                _scanInstance = new Scan();
                _fileCountTot = 0;
                string paras = null;
                VirInfoList.Clear();
                DisableAllFuncBtn();
                TbCurrentTarget.Text = "正在初始化引擎并更新病毒库, 可能需要较长时间...";
                ScanProcessBar.Visibility = Visibility.Visible;
                FileNameTextBox.Visibility = Visibility.Hidden;
                FileCountLabel.Content = "0";
                TimeLabel.Content = "00:00:00";
                ThreatLabel.Content = "0";
                SpeedLabel.Content = "0 个/s";
                if (!(EngineCloud.IsChecked ?? false))
                {
                    paras += " -!cloud";
                }
                if (!(EngineRdmPlus.IsChecked ?? false))
                {
                    paras += " -!rdm+";
                }
                if (EngineWorkers.IsChecked ?? false)
                {
                    string workers = ((int)SliderWorkers.Value).ToString();
                    paras += " -workers=";
                    paras += workers;
                }
                if (LogOutput.IsChecked ?? false)
                {
                    paras += $" \"-log={Environment.CurrentDirectory}\\ScanLog_{DateTime.Now:yyMMddhhmmss}.log\"";
                }
                if (_scanInstance.Start(FileNameTextBox.Text, paras, UpdateVirInfoListView, UpdateResUsageInfoView))
                {
                    ButtonStart.Content = "停止";
                    FileProcessUpdate(FileNameTextBox.Text);
                }
                else
                {
                    MessageBox.Show("指定查杀对象不存在", "提示", MessageBoxButton.OK, MessageBoxImage.Error);
                    TbCurrentTarget.Text = "";
                    ScanProcessBar.Visibility = Visibility.Hidden;
                    FileNameTextBox.Visibility = Visibility.Visible;
                }
            }
            else
            {
                _scanInstance.StopScan();
                ButtonStart.Content = "开始";
            }
        }

        private void Scan_OnMouseDown(object sender, MouseButtonEventArgs e)
        {
            ScanGrid.Margin = new Thickness(129, 122, 0, 0);
            ResultGrid.Visibility = Visibility.Hidden;
            ConfigGrid.Visibility = Visibility.Hidden;
            ScanGrid.Visibility = Visibility.Visible;
        }

        private void Result_OnMouseDown(object sender, MouseButtonEventArgs e)
        {
            ResultGrid.Margin = new Thickness(129, 122, 0, 0);
            ResultGrid.Visibility = Visibility.Visible;
            ConfigGrid.Visibility = Visibility.Hidden;
            ScanGrid.Visibility = Visibility.Hidden;
        }

        private void Config_OnMouseDown(object sender, MouseButtonEventArgs e)
        {
            ConfigGrid.Margin = new Thickness(129, 122, 0, 0);
            ResultGrid.Visibility = Visibility.Hidden;
            ConfigGrid.Visibility = Visibility.Visible;
            ScanGrid.Visibility = Visibility.Hidden;
        }

        private void CheckBox_Click_All(object sender, RoutedEventArgs e)
        {
            foreach (var i in VirInfoList)
            {
                if (CheckBoxSelectAll.IsChecked ?? false)
                {
                    i.IsSelected = true;
                }
                else
                {
                    i.IsSelected = false;
                }
            }
            ListViewVirInfo.Items.Refresh();
        }
        private void PackItems_OnClick(object sender, RoutedEventArgs routedEventArgs)
        {
            List<string> fileList = new List<string>();
            foreach (var i in VirInfoList)
            {
                if (i.IsSelected && i.DealState.IndexOf("删除成功", StringComparison.Ordinal) < 0)
                {
                    fileList.Add(i.FileName);
                }
            }
            if (fileList.Count == 0)
            {
                MessageBox.Show("没有勾选任何文件", "提示", MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }
            string strZipFilePath =
                $"{Environment.CurrentDirectory}\\PackedFiles_{DateTime.Now:yyMMddhhmmss}.zip";
            string failToPack = "";
            using (ZipFile zip = ZipFile.Create(strZipFilePath))
            {
                zip.BeginUpdate();
                long k = 0;
                foreach (var i in fileList)
                {
                    try
                    {
                        zip.Add(i);
                    }
                    catch
                    {
                        failToPack += i + "\r\n";
                    }
                    DealProcessBar.Value = (++k) * 100 / fileList.Count;
                }
                try
                {
                    zip.CommitUpdate();
                }
                catch
                {
                    try
                    {
                        File.Delete(strZipFilePath);
                    }
                    catch
                    {
                        // ignored
                    }
                    MessageBox.Show("文件打包失败, 可能是因为权限不足", "提示", MessageBoxButton.OK, MessageBoxImage.Information);
                    return;
                }
            }
            if (!String.IsNullOrEmpty(failToPack))
            {
                MessageBox.Show($"部分文件已成功打包至 {strZipFilePath}\r\n以下文件无法打包, 可能是因为权限不足: \r\n{failToPack}", "提示",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
            else
            {
                MessageBox.Show("文件已成功打包至 " + strZipFilePath, "提示", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        //private void UploadItems_OnClick(object sender, RoutedEventArgs routedEventArgs)
        //{

        //}

        private void DeleteItems_OnClick(object sender, RoutedEventArgs routedEventArgs)
        {
            long k = 0, tot = 0;
            foreach (var i in VirInfoList)
            {
                if (i.IsSelected && i.DealState.IndexOf("成功", StringComparison.Ordinal) < 0)
                {
                    tot++;
                }
            }
            if (tot == 0)
            {
                return;
            }
            foreach (var i in VirInfoList)
            {
                if (i.IsSelected && i.DealState.IndexOf("成功", StringComparison.Ordinal) < 0)
                {
                    try
                    {
                        File.Delete(i.FileName);
                        i.IsSelected = false;
                        if (CheckBoxSelectAll.IsChecked ?? false)
                        {
                            CheckBoxSelectAll.IsChecked = false;
                        }
                        i.DealState = "删除成功";
                    }
                    catch
                    {
                        i.DealState = "删除失败";
                    }
                }
                DealProcessBar.Value = (++k) * 100 / tot;
            }
            ListViewVirInfo.Items.Refresh();
        }

        private void FolderTree_OnSelected(object sender, RoutedEventArgs e)
        {
            string fileName = "";
            var a = e.OriginalSource as TreeViewItem;
            do
            {
                if (a != null)
                {
                    var folder = a.Header as Folder;
                    if (folder != null)
                    {
                        fileName = folder.Name + "\\" + fileName;
                    }
                    ItemsControl parent = GetSelectedTreeViewItemParent(a);
                    a = parent as TreeViewItem;
                }
            } while (a != null);
            FileNameTextBox.Text = fileName.Remove(fileName.Length - 1);
        }

        private void DoGetNextFolder(string path, long count, ObservableCollection<Folder> root)
        {
            if (root != null)
            {
                foreach (var i in root)
                {
                    if (i.Count == count)
                    {
                        if (i.isExpanded == false)
                        {
                            i.isExpanded = true;
                            var j = i.Children;
                            foreach (var k in j)
                            {
                                try
                                {
                                    foreach (var l in Directory.GetDirectories(path + "\\" + k.Name))
                                    {
                                        Dispatcher.BeginInvoke((Action)(() =>
                                        {
                                            k.Children.Add(new Folder { Name = Path.GetFileName(l), Count = ++_fileCountTot });
                                        }));
                                    }
                                }
                                catch
                                {
                                    //ignored
                                }
                            }
                        }
                    }
                    else
                    {
                        DoGetNextFolder(path, count, i.Children);
                    }
                }
            }
        }
        private void GetNextFolder(string path, long count, ObservableCollection<Folder> root)
        {
            Task.Run(() =>
            {
                DoGetNextFolder(path, count, root);
                _expanding--;
                if (_expanding == 0)
                {
                    Dispatcher.BeginInvoke((Action)(() =>
                    {
                        FolderLoading.Visibility = Visibility.Hidden;
                        FolderRefresh.IsEnabled = true;
                    }));
                }
            });
        }

        private int _expanding;
        private void FolderTree_OnExpanded(object sender, RoutedEventArgs e)
        {
            string fileName = "";
            var a = e.OriginalSource as TreeViewItem;
            long curCount;
            if (a != null)
            {
                var folder = a.Header as Folder;
                if (folder != null) curCount = folder.Count;
                else return;
            }
            else
            {
                return;
            }
            do
            {
                var folder = a.Header as Folder;
                if (folder != null)
                {
                    fileName = folder.Name + "\\" + fileName;
                }
                ItemsControl parent = GetSelectedTreeViewItemParent(a);
                a = parent as TreeViewItem;
            } while (a != null);
            fileName = fileName.Remove(fileName.Length - 1);
            FolderRefresh.IsEnabled = false;
            FolderLoading.Visibility = Visibility.Visible;
            _expanding++;
            GetNextFolder(fileName, curCount, FolderList);
        }
        private ItemsControl GetSelectedTreeViewItemParent(TreeViewItem item)
        {
            DependencyObject parent = VisualTreeHelper.GetParent(item);
            while (!(parent is TreeViewItem || parent is TreeView))
            {
                parent = VisualTreeHelper.GetParent(parent);
            }

            return parent as ItemsControl;
        }

        private void FolderRefresh_OnClick(object sender, RoutedEventArgs e)
        {
            InitFolderTree();
        }
    }
}
